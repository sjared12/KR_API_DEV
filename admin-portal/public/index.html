<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Portal</title>
  <style>
    :root {
      --primary: #4f46e5;
      --primary-dark: #4338ca;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --border: #475569;
      --shadow: rgba(0, 0, 0, 0.3);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 2rem;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    header {
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 2px solid var(--border);
    }
    
    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #818cf8 0%, #c084fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }
    
    .subtitle {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }
    
    .auth-section {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 6px var(--shadow);
      border: 1px solid var(--border);
    }
    
    .auth-section label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .auth-controls {
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }
    
    input[type="password"] {
      flex: 1;
      padding: 0.75rem 1rem;
      background: var(--bg-primary);
      border: 2px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.95rem;
      transition: all 0.2s;
    }
    
    input[type="password"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    button {
      padding: 0.75rem 1.5rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    button:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px var(--shadow);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button.btn-success {
      background: var(--success);
    }
    
    button.btn-success:hover {
      background: #059669;
    }
    
    button.btn-danger {
      background: var(--danger);
    }
    
    button.btn-danger:hover {
      background: #dc2626;
    }
    
    button.btn-secondary {
      background: var(--bg-tertiary);
    }
    
    button.btn-secondary:hover {
      background: #475569;
    }
    
    .card {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 6px var(--shadow);
      border: 1px solid var(--border);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    
    .card-header h2 {
      font-size: 1.5rem;
      font-weight: 600;
    }
    
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    
    thead {
      background: var(--bg-tertiary);
    }
    
    th {
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      border-bottom: 2px solid var(--border);
    }
    
    th:first-child {
      border-top-left-radius: 8px;
    }
    
    th:last-child {
      border-top-right-radius: 8px;
    }
    
    td {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
    }
    
    tbody tr {
      transition: background 0.2s;
    }
    
    tbody tr:hover {
      background: var(--bg-tertiary);
    }
    
    tbody tr:last-child td:first-child {
      border-bottom-left-radius: 8px;
    }
    
    tbody tr:last-child td:last-child {
      border-bottom-right-radius: 8px;
    }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.375rem 0.75rem;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 600;
      gap: 0.5rem;
    }
    
    .status-badge::before {
      content: '';
      display: block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .status-running {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
    }
    
    .status-running::before {
      background: var(--success);
    }
    
    .status-stopped {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
    }
    
    .status-stopped::before {
      background: var(--danger);
      animation: none;
    }

    .status-maintenance {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
    }

    .status-maintenance::before {
      background: var(--warning);
    }

    .status-deploying {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
    }

    .status-deploying::before {
      background: var(--warning);
    }
    
    .controls {
      display: flex;
      gap: 0.5rem;
    }
    
    .controls button {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .link-btn {
      background: transparent;
      color: #93c5fd;
      padding: 0;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }
    .link-btn:hover { text-decoration: underline; }
    
    .config-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1.5rem;
    }
    
    .config-card {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 1.25rem;
      border: 1px solid var(--border);
    }
    
    .config-card h3 {
      font-size: 1.125rem;
      margin-bottom: 1rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .config-card h3::before {
      content: '‚öô';
      font-size: 1.25rem;
    }
    
    textarea {
      width: 100%;
      height: 180px;
      padding: 1rem;
      background: var(--bg-primary);
      border: 2px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      font-size: 0.875rem;
      line-height: 1.5;
      resize: vertical;
      transition: border-color 0.2s;
    }
    
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    .config-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    
    .config-actions button {
      flex: 1;
    }
    
    .info-text {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: rgba(79, 70, 229, 0.1);
      border-left: 3px solid var(--primary);
      border-radius: 4px;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .config-section {
        grid-template-columns: 1fr;
      }
      
      .auth-controls {
        flex-direction: column;
      }
      
      input[type="password"] {
        width: 100%;
      }
      
      button {
        width: 100%;
      }
      
      .controls {
        flex-direction: column;
      }
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(4px);
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border);
      box-shadow: 0 20px 40px var(--shadow);
    }

    .modal-content.wide {
      max-width: 1100px;
      width: 95vw;
    }

    .modal-body {
      max-height: calc(90vh - 120px);
      overflow: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    
    .modal-header h2 {
      font-size: 1.5rem;
      margin: 0;
    }
    
    .close-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      line-height: 1;
    }
    
    .close-btn:hover {
      color: var(--text-primary);
      transform: none;
      box-shadow: none;
    }
    
    .form-group {
      margin-bottom: 1.25rem;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.75rem;
      background: var(--bg-primary);
      border: 2px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.95rem;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    .form-group small {
      display: block;
      margin-top: 0.25rem;
      color: var(--text-secondary);
      font-size: 0.8rem;
    }
    
    .form-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }
    
    .form-actions button {
      flex: 1;
    }
    
    .env-vars {
      margin-top: 0.75rem;
    }
    
    .env-var-row {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .env-var-row input {
      flex: 1;
    }
    
    .env-var-row button {
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
    }
  </style>
  <script>
    async function init() {
      await load();
    }

    async function load() {
      try {
        const resp = await fetch('/api/containers');
        if (!resp.ok) {
          console.error('Failed to load containers:', resp.status);
          document.getElementById('tbody').innerHTML = '<tr><td colspan="4" style="text-align:center; color: var(--danger);">Failed to load services. Check API configuration.</td></tr>';
          return;
        }
        const data = await resp.json();
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';
        
        if (!Array.isArray(data) || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: var(--text-secondary);">No services found. Configure DO_API_TOKEN and DO_APP_ID environment variables.</td></tr>';
          return;
        }
        
        data.forEach(item => {
          const tr = document.createElement('tr');
          const isMx = item.mxMode || item.state === 'mx';
          const isDeploying = !isMx && item.state !== 'running' && item.state !== 'archived' && (String(item.status||'').toLowerCase() === 'superseded');
          const statusClass = item.state === 'running' ? 'status-running' : (isMx ? 'status-maintenance' : (isDeploying ? 'status-deploying' : (item.state === 'archived' ? 'status-stopped' : 'status-stopped')));
          const statusText = item.state === 'running' ? 'Running' : (isMx ? 'MX Mode' : (isDeploying ? 'Deploying' : (item.state === 'archived' ? 'Archived' : 'Stopped')));
          const target = encodeURIComponent(item.id || item.name);
          let actionBtn = '';
          if (item.state === 'running') {
            actionBtn = `<button class=\"btn-danger\" onclick=\"ctrl('${target}','stop')\">Stop</button>`;
          } else if (isMx || item.state === 'archived' || isDeploying) {
            // App Platform does not support start/stop; hide misleading Start for archived/maintenance
            actionBtn = '';
          } else {
            actionBtn = `<button class=\"btn-success\" onclick=\"ctrl('${target}','start')\">Start</button>`;
          }
          
          tr.innerHTML = `
            <td><button class=\"link-btn\" title=\"View details\" onclick=\"showDetails('${target}')\"><strong>${item.name}</strong></button></td>
            <td><code style=\"font-size: 0.85rem; color: var(--text-secondary);\">${item.image}</code></td>
            <td><span class=\"status-badge ${statusClass}\">${statusText}</span></td>
            <td class=\"controls\">
              <button class=\"btn-secondary\" onclick=\"ctrl('${target}','restart')\">Restart</button>
              ${actionBtn}
              <button class=\"btn-danger\" onclick=\"deleteService('${target}')\">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        console.error('Error loading containers:', e);
        document.getElementById('tbody').innerHTML = '<tr><td colspan="4" style="text-align:center; color: var(--danger);">Error loading services.</td></tr>';
      }
    }
    async function ctrl(target, action) {
      const resp = await fetch(`/api/containers/${target}/${action}`, { method: 'POST' });
      if (resp.ok) {
        await load();
      } else {
        const e = await resp.json().catch(()=>({error:'error'}));
        alert('Action failed: ' + (e.error || resp.status));
      }
    }
    async function deleteService(target) {
      if (!confirm(`Are you sure you want to delete ${decodeURIComponent(target)}? This cannot be undone.`)) {
        return;
      }
      const resp = await fetch(`/api/containers/${target}`, { method: 'DELETE' });
      if (resp.ok) {
        await load();
      } else {
        const e = await resp.json().catch(()=>({error:'error'}));
        alert('Delete failed: ' + (e.error || resp.status));
      }
    }
    function openCreateModal() {
      document.getElementById('createModal').classList.add('active');
    }
    function closeCreateModal() {
      document.getElementById('createModal').classList.remove('active');
      document.getElementById('createForm').reset();
      document.getElementById('envVarsList').innerHTML = '';
    }
    function toggleSourceFields() {
      const sourceType = document.getElementById('sourceType').value;
      document.getElementById('imageFields').style.display = sourceType === 'image' ? 'block' : 'none';
      document.getElementById('githubFields').style.display = sourceType === 'github' ? 'block' : 'none';
    }
    function addEnvVar() {
      const container = document.getElementById('envVarsList');
      const row = document.createElement('div');
      row.className = 'env-var-row';
      row.innerHTML = `
        <input type="text" placeholder="KEY" class="env-key" />
        <input type="text" placeholder="value" class="env-value" />
        <button type="button" class="btn-danger" onclick="this.parentElement.remove()">‚úï</button>
      `;
      container.appendChild(row);
    }
    async function createService(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      
      const envVars = [];
      document.querySelectorAll('.env-var-row').forEach(row => {
        const key = row.querySelector('.env-key').value.trim();
        const value = row.querySelector('.env-value').value.trim();
        if (key) envVars.push({ key, value });
      });
      
      const payload = {
        name: formData.get('name'),
        source_type: formData.get('source_type'),
        instance_size: formData.get('instance_size'),
        instance_count: parseInt(formData.get('instance_count')),
        http_port: formData.get('http_port') ? parseInt(formData.get('http_port')) : null,
        env_vars: envVars
      };
      
      if (payload.source_type === 'image') {
        payload.image_registry = formData.get('image_registry');
        payload.image_repository = formData.get('image_repository');
        payload.image_tag = formData.get('image_tag');
      } else {
        payload.github_repo = formData.get('github_repo');
        payload.github_branch = formData.get('github_branch');
        payload.dockerfile_path = formData.get('dockerfile_path');
      }
      
      const resp = await fetch('/api/containers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if (resp.ok) {
        closeCreateModal();
        await load();
        alert('Service created successfully! Deployment will begin shortly.');
      } else {
        const e = await resp.json().catch(()=>({error:'error'}));
        alert('Create failed: ' + (e.error || resp.status));
      }
    }
    async function loadCfg(service) {
      const resp = await fetch(`/api/config/${service}`);
      const data = await resp.json();
      document.getElementById(`cfg-${service}`).value = JSON.stringify(data || {}, null, 2);
    }
    async function saveCfg(service) {
      
      const val = document.getElementById(`cfg-${service}`).value;
      let obj;
      try { obj = JSON.parse(val); } catch { alert('Invalid JSON'); return; }
      const resp = await fetch(`/api/config/${service}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(obj) });
      if (!resp.ok) {
        const e = await resp.json().catch(()=>({error:'error'}));
        alert('Save failed: ' + (e.error || resp.status));
      } else {
        alert('Saved. Restart services to apply env-only changes.');
      }
    }
    window.addEventListener('DOMContentLoaded', init);

    async function showDetails(target) {
      const modal = document.getElementById('detailsModal');
      const body = document.getElementById('detailsBody');
      body.innerHTML = '<div style="color:var(--text-secondary)">Loading‚Ä¶</div>';
      modal.classList.add('active');
      modal.dataset.target = target;
      document.getElementById('detailsEditFooter').style.display = 'none';
      document.getElementById('detailsEditBtn').style.display = '';
      try {
        const resp = await fetch(`/api/containers/${target}`);
        if (!resp.ok) {
          const e = await resp.json().catch(()=>({error:'error'}));
          body.innerHTML = `<div style='color: var(--danger)'>Failed to load: ${e.error || resp.status}</div>`;
          return;
        }
        const d = await resp.json();
        const isDeploying = String(d.status?.state||'').toLowerCase() !== 'running' && String(d.status?.health||'').toLowerCase() !== 'healthy' && String(d.status?.health||'').toLowerCase() !== 'unhealthy' && String(d.status?.state||'').toLowerCase() !== 'archived' && String(d.status?.mxMode||'') !== 'true' && String(d.status?.health||'').toLowerCase() === 'superseded' || String(d.status?.state||'').toLowerCase() === 'superseded';
        const badge = d.status.state === 'running'
          ? '<span class="status-badge status-running">Running</span>'
          : (d.status.state === 'mx'
            ? '<span class="status-badge status-maintenance">MX Mode</span>'
            : (d.status.state === 'archived'
              ? '<span class="status-badge status-stopped">Archived</span>'
              : (isDeploying
                ? '<span class="status-badge status-deploying">Deploying</span>'
                : `<span class="status-badge status-stopped">${d.status.state}</span>`)));
        const source = d.service.source.type === 'github' ? `${d.service.source.repo}@${d.service.source.branch || 'main'}${d.service.source.dockerfile_path ? ' ‚Ä¢ ' + d.service.source.dockerfile_path : ''}` : (d.service.source.type === 'image' ? `${d.service.source.repository}:${d.service.source.tag || 'latest'}` : 'Unknown');
        const envRows = (d.service.envs || []).map(ev => `<tr><td>${ev.key}</td><td><code>${ev.value || '(secret)'}</code></td><td>${ev.scope || ''}</td></tr>`).join('') || '<tr><td colspan="3" style="color:var(--text-secondary)">None</td></tr>';
        const ingress = (d.ingress || []).map(r => `${r.match?.path?.prefix || '/'} ‚Üí ${r.component?.name}`).join('<br/>') || '<span style="color:var(--text-secondary)">None</span>';
        const events = (d.deployment.events || []).map(e => `${e.name}: ${e.status}`).join('<br/>') || '<span style="color:var(--text-secondary)">None</span>';

        body.innerHTML = `
          <div class="config-section">
            <div class="config-card">
              <h3>Overview</h3>
              <div class="info-text">${badge}</div>
              <div><strong>App:</strong> ${d.app.name} (${d.app.id})</div>
              <div><strong>Service:</strong> ${d.service.name} (${d.service.type})</div>
              <div><strong>Region:</strong> ${d.app.region} ‚Ä¢ <strong>Tier:</strong> ${d.app.tier}</div>
              <div><strong>URL:</strong> <a href="${d.app.live_url}" target="_blank">${d.app.live_url}</a></div>
            </div>
            <div class="config-card">
              <h3>Runtime</h3>
              <div><strong>Instances:</strong> ${d.service.instance_count ?? '‚Äî'}</div>
              <div><strong>Size:</strong> ${d.service.instance_size_slug ?? '‚Äî'}</div>
              <div><strong>Port:</strong> ${d.service.http_port ?? '‚Äî'}</div>
              <div><strong>Routes:</strong> ${(d.service.routes || []).map(r=>r.path).join(', ') || '‚Äî'}</div>
              <div><strong>Source:</strong> ${source}</div>
            </div>
            <div class="config-card">
              <h3>Deployment</h3>
              <div><strong>Phase:</strong> ${d.deployment.phase || '‚Äî'}</div>
              <div><strong>Deployment ID:</strong> ${d.deployment.id || '‚Äî'}</div>
              <div><strong>Commit:</strong> ${d.deployment.commit || '‚Äî'}</div>
              <div style="margin-top:0.5rem;"><strong>Events:</strong><br/>${events}</div>
            </div>
            <div class="config-card" style="grid-column:1 / -1;">
              <h3>Environment</h3>
              <table style="width:100%">
                <thead><tr><th>Key</th><th>Value</th><th>Scope</th></tr></thead>
                <tbody>${envRows}</tbody>
              </table>
            </div>
            <div class="config-card" style="grid-column:1 / -1;">
              <h3>Ingress</h3>
              <div>${ingress}</div>
            </div>
          </div>
          <div class="config-card" style="margin-top:1rem;">
            <h3>Raw</h3>
            <pre style="white-space:pre-wrap;max-height:300px;overflow:auto;background:var(--bg-primary);padding:1rem;border-radius:8px;border:1px solid var(--border);">${escapeHtml(JSON.stringify(d, null, 2))}</pre>
          </div>
        `;
      } catch (err) {
        body.innerHTML = `<div style='color: var(--danger)'>Error: ${err.message}</div>`;
      }
    }

    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    function closeDetails(){
      document.getElementById('detailsModal').classList.remove('active');
    }

    function enterEditDetails(){
      const modal = document.getElementById('detailsModal');
      const target = modal.dataset.target;
      const body = document.getElementById('detailsBody');
      fetch(`/api/containers/${target}`).then(r=>r.json()).then(d=>{
        const envRows = (d.service.envs || []).map(ev => `
          <tr class="edit-env-row">
            <td><input value="${ev.key || ''}" placeholder="KEY" /></td>
            <td><input value="${ev.value || ''}" placeholder="value" /></td>
            <td>
              <select>
                <option value="RUN_TIME" ${ev.scope==='RUN_TIME'?'selected':''}>RUN_TIME</option>
                <option value="RUN_AND_BUILD_TIME" ${ev.scope==='RUN_AND_BUILD_TIME'?'selected':''}>RUN_AND_BUILD_TIME</option>
              </select>
            </td>
          </tr>
        `).join('');
        body.innerHTML = `
          <div class="config-section">
            <div class="config-card">
              <h3>Scale & Runtime</h3>
              <div class="form-group"><label>Instance Count</label><input id="edit-instance-count" type="number" min="0" value="${d.service.instance_count ?? 1}" /></div>
              <div class="form-group"><label>Instance Size Slug</label><input id="edit-instance-size" value="${d.service.instance_size_slug || ''}" /></div>
              <div class="form-group"><label>HTTP Port</label><input id="edit-http-port" type="number" value="${d.service.http_port ?? ''}" /></div>
            </div>
            <div class="config-card" style="grid-column:1 / -1;">
              <h3>Environment Variables</h3>
              <table style="width:100%">
                <thead><tr><th>Key</th><th>Value</th><th>Scope</th></tr></thead>
                <tbody id="edit-env-tbody">${envRows || '<tr class=\'edit-env-row\'><td><input placeholder="KEY"/></td><td><input placeholder="value"/></td><td><select><option value="RUN_TIME" selected>RUN_TIME</option><option value="RUN_AND_BUILD_TIME">RUN_AND_BUILD_TIME</option></select></td></tr>'}</tbody>
              </table>
              <div class="config-actions"><button class="btn-secondary" onclick="addEditEnvRow()">+ Add Variable</button></div>
            </div>
          </div>
        `;
        document.getElementById('detailsEditBtn').style.display = 'none';
        document.getElementById('detailsEditFooter').style.display = 'flex';
      }).catch(err=>{
        body.innerHTML = `<div style='color: var(--danger)'>Error: ${err.message}</div>`;
      });
    }

    function addEditEnvRow(){
      const tb = document.getElementById('edit-env-tbody');
      const tr = document.createElement('tr');
      tr.className = 'edit-env-row';
      tr.innerHTML = `<td><input placeholder="KEY"/></td><td><input placeholder="value"/></td><td><select><option value="RUN_TIME" selected>RUN_TIME</option><option value="RUN_AND_BUILD_TIME">RUN_AND_BUILD_TIME</option></select></td>`;
      tb.appendChild(tr);
    }

    function cancelEditDetails(){
      const target = document.getElementById('detailsModal').dataset.target;
      showDetails(target);
    }

    async function saveEditDetails(){
      const modal = document.getElementById('detailsModal');
      const target = modal.dataset.target;
      const envs = Array.from(document.querySelectorAll('#edit-env-tbody .edit-env-row')).map(tr => {
        const tds = tr.querySelectorAll('td');
        return { key: tds[0].querySelector('input').value.trim(), value: tds[1].querySelector('input').value, scope: tds[2].querySelector('select').value };
      }).filter(ev => ev.key);
      const payload = {
        instance_count: parseInt(document.getElementById('edit-instance-count').value, 10),
        instance_size_slug: document.getElementById('edit-instance-size').value.trim(),
        http_port: document.getElementById('edit-http-port').value ? parseInt(document.getElementById('edit-http-port').value, 10) : null,
        envs
      };
      const resp = await fetch(`/api/containers/${target}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      if (resp.ok) {
        await showDetails(target);
      } else {
        const e = await resp.json().catch(()=>({error:'error'}));
        alert('Save failed: ' + (e.error || resp.status));
      }
    }
  </script>
</head>
<body>
  <div class="container">
    <header>
      <h1>‚ö° Admin Portal</h1>
      <p class="subtitle">Container & Service Management Dashboard</p>
    </header>

    <!-- Auth removed by request; refresh button moved to table header -->

    <div class="card">
      <div class="card-header">
        <h2>üê≥ Container Status</h2>
        <div style="display:flex; gap:0.5rem;">
          <button class="btn-secondary" onclick="load()">üîÑ Refresh</button>
          <button onclick="openCreateModal()">‚ûï Create Service</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Container Name</th>
            <th>Image</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- Create Service Modal -->
    <div id="detailsModal" class="modal">
      <div class="modal-content wide">
        <div class="modal-header">
          <h2>Service Details</h2>
          <div style="display:flex; gap:.5rem; align-items:center;">
            <button class="btn-secondary" id="detailsEditBtn" onclick="enterEditDetails()">Edit</button>
            <button class="close-btn" onclick="closeDetails()">‚úï</button>
          </div>
        </div>
        <div class="modal-body" id="detailsBody"></div>
        <div id="detailsEditFooter" style="display:none; margin-top:1rem; border-top:1px solid var(--border); padding-top:1rem; display:flex; gap:.5rem; justify-content:flex-end;">
          <button class="btn-secondary" onclick="cancelEditDetails()">Cancel</button>
          <button class="btn-success" onclick="saveEditDetails()">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Create Service Modal -->
    <div id="createModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Create New Service</h2>
          <button class="close-btn" onclick="closeCreateModal()">‚úï</button>
        </div>
        <form id="createForm" onsubmit="createService(event)">
          <div class="form-group">
            <label>Service Name *</label>
            <input type="text" name="name" required placeholder="my-service" />
            <small>Lowercase letters, numbers, and hyphens only</small>
          </div>
          
          <div class="form-group">
            <label>Source Type *</label>
            <select name="source_type" id="sourceType" onchange="toggleSourceFields()" required>
              <option value="image">Docker Image</option>
              <option value="github">GitHub Repository</option>
            </select>
          </div>
          
          <div id="imageFields">
            <div class="form-group">
              <label>Registry</label>
              <select name="image_registry">
                <option value="DOCKER_HUB">Docker Hub</option>
                <option value="GHCR">GitHub Container Registry</option>
              </select>
            </div>
            <div class="form-group">
              <label>Image Repository *</label>
              <input type="text" name="image_repository" placeholder="nginx" />
            </div>
            <div class="form-group">
              <label>Tag</label>
              <input type="text" name="image_tag" placeholder="latest" value="latest" />
            </div>
          </div>
          
          <div id="githubFields" style="display: none;">
            <div class="form-group">
              <label>GitHub Repository *</label>
              <input type="text" name="github_repo" placeholder="owner/repo" />
            </div>
            <div class="form-group">
              <label>Branch</label>
              <input type="text" name="github_branch" placeholder="main" value="main" />
            </div>
            <div class="form-group">
              <label>Dockerfile Path</label>
              <input type="text" name="dockerfile_path" placeholder="Dockerfile" />
              <small>Leave empty if Dockerfile is in root</small>
            </div>
          </div>
          
          <div class="form-group">
            <label>Instance Size</label>
            <select name="instance_size">
              <option value="basic-xxs">Basic XXS ($5/mo)</option>
              <option value="basic-xs">Basic XS ($12/mo)</option>
              <option value="basic-s">Basic S ($25/mo)</option>
              <option value="basic-m">Basic M ($50/mo)</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Instance Count</label>
            <input type="number" name="instance_count" value="1" min="1" max="10" />
          </div>
          
          <div class="form-group">
            <label>HTTP Port</label>
            <input type="number" name="http_port" placeholder="8080" />
            <small>Leave empty if not a web service</small>
          </div>
          
          <div class="form-group">
            <label>Environment Variables</label>
            <div id="envVarsList" class="env-vars"></div>
            <button type="button" class="btn-secondary" onclick="addEnvVar()">+ Add Variable</button>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="closeCreateModal()">Cancel</button>
            <button type="submit">Create Service</button>
          </div>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2>‚öôÔ∏è Service Configuration</h2>
      </div>
      <p class="info-text">
        üìù Edit JSON configuration for each service. Environment variable changes require container restart to take effect.
      </p>
      <div class="config-section">
        <div class="config-card">
          <h3>API Service</h3>
          <textarea id="cfg-api" placeholder="{}"></textarea>
          <div class="config-actions">
            <button class="btn-secondary" onclick="loadCfg('api')">üì• Load</button>
            <button onclick="saveCfg('api')">üíæ Save</button>
          </div>
        </div>

        <div class="config-card">
          <h3>Payment Service</h3>
          <textarea id="cfg-payment" placeholder="{}"></textarea>
          <div class="config-actions">
            <button class="btn-secondary" onclick="loadCfg('payment')">üì• Load</button>
            <button onclick="saveCfg('payment')">üíæ Save</button>
          </div>
        </div>

        <div class="config-card">
          <h3>Logger Service</h3>
          <textarea id="cfg-logger" placeholder="{}"></textarea>
          <div class="config-actions">
            <button class="btn-secondary" onclick="loadCfg('logger')">üì• Load</button>
            <button onclick="saveCfg('logger')">üíæ Save</button>
          </div>
        </div>

        <div class="config-card">
          <h3>Feedback Service</h3>
          <textarea id="cfg-feedback" placeholder="{}"></textarea>
          <div class="config-actions">
            <button class="btn-secondary" onclick="loadCfg('feedback')">üì• Load</button>
            <button onclick="saveCfg('feedback')">üíæ Save</button>
          </div>
        </div>

        <div class="config-card">
          <h3>Proxy Service</h3>
          <textarea id="cfg-proxy" placeholder="{}"></textarea>
          <div class="config-actions">
            <button class="btn-secondary" onclick="loadCfg('proxy')">üì• Load</button>
            <button onclick="saveCfg('proxy')">üíæ Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
