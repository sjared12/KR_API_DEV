<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Feedback Admin</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; 
      margin: 0; 
      color: #f3f4f6; 
      background-image: url('/background.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
      min-height: 100vh;
    }
    /* Dark overlay for readability (match gate.html) */
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, rgba(60,60,60,0.80) 0%, rgba(120,120,120,0.60) 100%);
      z-index: 0;
      pointer-events: none;
    }
    .container { max-width: 1200px; margin: 40px auto; padding: 24px; position: relative; z-index: 1; }
    h1 { margin-top: 0; font-size: 1.75rem; color: #f8fafc; text-shadow: 0 2px 6px rgba(0,0,0,0.4); }
    
    /* Login form */
    .login-box { 
      max-width: 420px; margin: 0 auto; 
      background: linear-gradient(180deg, rgba(124, 90, 42, 0.85), rgba(63, 45, 20, 0.92)); 
      border-radius: 12px; padding: 32px; 
      box-shadow: 0 20px 60px rgba(40,25,10,0.6); 
      border: 1px solid rgba(201,176,55,0.25);
      backdrop-filter: blur(6px);
    }
    .login-box label { display: block; margin: 12px 0 6px; color: #e5e7eb; }
    .login-box input { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(201,176,55,0.25); background: rgba(63,45,20,0.75); color: #f8fafc; box-sizing: border-box; }
    .login-box input:focus { outline: none; border-color: #c9b037; box-shadow: 0 0 0 3px rgba(201,176,55,0.15); background: rgba(63,45,20,0.92); }
    .login-box button { width: 100%; margin-top: 16px; background: linear-gradient(135deg, #c9b037 0%, #7c5a2a 100%); color: white; border: 0; border-radius: 8px; padding: 12px; cursor: pointer; font-size: 1rem; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .login-box button:hover { box-shadow: 0 8px 20px rgba(201,176,55,0.35); }
    .login-box .error { color: #f87171; margin-top: 12px; }

    /* Table view */
    .admin-view { display: none; }
    .admin-view.active { display: block; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .logout-btn { background: rgba(63,45,20,0.75); border: 1px solid rgba(201,176,55,0.25); color: #f8fafc; border-radius: 8px; padding: 8px 16px; cursor: pointer; }
  .logout-btn:hover { background: rgba(63,45,20,0.92); box-shadow: 0 6px 16px rgba(201,176,55,0.25); }
    
    table { width: 100%; border-collapse: collapse; background: rgba(63,45,20,0.80); border-radius: 8px; overflow: hidden; border: 1px solid rgba(201,176,55,0.20); }
    th, td { text-align: left; padding: 12px; border-bottom: 1px solid rgba(201,176,55,0.20); }
    th { background: rgba(124,90,42,0.85); color: #f8fafc; font-weight: 700; }
    tr:hover { background: rgba(63,45,20,0.92); }
    .rating { font-weight: bold; color: #fbbf24; }
    .actions button { background: linear-gradient(135deg, #c9b037 0%, #7c5a2a 100%); color: white; border: 0; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 0.875rem; }
    .actions button:hover { box-shadow: 0 6px 16px rgba(201,176,55,0.35); }
    .no-data { text-align: center; padding: 40px; color: #e5e7eb; }
    .summary { display: flex; gap: 24px; margin-bottom: 24px; }
    .summary-card { flex: 1; background: rgba(63,45,20,0.80); border-radius: 8px; padding: 16px; border: 1px solid rgba(201,176,55,0.20); }
    .summary-card h3 { margin: 0 0 8px; font-size: 0.875rem; color: #f3f4f6; text-transform: uppercase; letter-spacing: 0.04em; }
    .summary-card .value { font-size: 2rem; font-weight: bold; color: #fbbf24; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login Form -->
    <div id="loginBox" class="login-box">
      <h1>Feedback Admin Login</h1>
      <form id="loginForm">
        <label for="username">Username</label>
        <input id="username" type="text" required autocomplete="username" />
        
        <label for="password">Password</label>
        <input id="password" type="password" required autocomplete="current-password" />
        
        <button type="submit">Log In</button>
        <div id="loginError" class="error"></div>
      </form>
    </div>

    <!-- Admin View -->
    <div id="adminView" class="admin-view">
      <div class="header">
        <h1>Feedback Responses</h1>
        <button class="logout-btn" onclick="logout()">Log Out</button>
      </div>

      <div class="summary">
        <div class="summary-card">
          <h3>Total Responses</h3>
          <div class="value" id="totalCount">0</div>
        </div>
        <div class="summary-card">
          <h3>Average Rating</h3>
          <div class="value" id="avgRating">-</div>
        </div>
      </div>

      <table id="feedbackTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Event</th>
            <th>Rating</th>
            <th>Comments</th>
            <th>Email</th>
            <th>Created At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="7" class="no-data">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let authToken = null;

    // Check if already logged in
    const storedAuth = sessionStorage.getItem('feedbackAdminAuth');
    if (storedAuth) {
      authToken = storedAuth;
      loadFeedback();
    }

    // Handle login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const loginError = document.getElementById('loginError');
      loginError.textContent = '';

  // Create Basic Auth token (sent via custom header to avoid native HTTP Basic interception)
  authToken = 'Basic ' + btoa(username + ':' + password);

      try {
        const res = await fetch('/api/feedback-admin/responses', {
          headers: { 'X-Feedback-Admin-Auth': authToken }
        });

        if (res.status === 401 || res.status === 403) {
          loginError.textContent = 'Invalid username or password';
          authToken = null;
          return;
        }

        if (!res.ok) {
          throw new Error('Login failed');
        }

        // Store auth token in session
        sessionStorage.setItem('feedbackAdminAuth', authToken);
        
        // Show admin view
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('adminView').classList.add('active');
        
        loadFeedback();
      } catch (err) {
        loginError.textContent = 'Login failed. Please try again.';
        authToken = null;
      }
    });

    // Load feedback data
    async function loadFeedback() {
      try {
        const res = await fetch('/api/feedback-admin/responses', {
          headers: { 'X-Feedback-Admin-Auth': authToken }
        });

        if (res.status === 401 || res.status === 403) {
          logout();
          return;
        }

        if (!res.ok) {
          throw new Error('Failed to load feedback');
        }

        const data = await res.json();
        renderTable(data);
        renderSummary(data);
      } catch (err) {
        console.error('Error loading feedback:', err);
        document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" class="no-data">Error loading data</td></tr>';
      }
    }

    // Render table
    function renderTable(data) {
      const tbody = document.getElementById('tableBody');
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="no-data">No feedback responses yet</td></tr>';
        return;
      }

      tbody.innerHTML = data.map(item => {
        const createdAt = new Date(item.createdAt).toLocaleString();
        return `
          <tr>
            <td>${item.id}</td>
            <td>${escapeHtml(item.eventName || '-')}</td>
            <td class="rating">${item.rating || '-'}</td>
            <td>${escapeHtml(item.comments || '-')}</td>
            <td>${escapeHtml(item.email || '-')}</td>
            <td>${createdAt}</td>
            <td class="actions">
              <button onclick="deleteResponse(${item.id})">Delete</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Render summary
    function renderSummary(data) {
      document.getElementById('totalCount').textContent = data.length;
      
      if (data.length === 0) {
        document.getElementById('avgRating').textContent = '-';
        return;
      }

      const sum = data.reduce((acc, item) => acc + (item.rating || 0), 0);
      const avg = sum / data.length;
      const percent = (avg / 5) * 100;
      document.getElementById('avgRating').textContent = `${percent.toFixed(0)}% (${avg.toFixed(2)}/5)`;
    }

    // Delete response
    async function deleteResponse(id) {
      if (!confirm('Are you sure you want to delete this feedback response?')) {
        return;
      }

      try {
        const res = await fetch(`/api/feedback-admin/responses/${id}`, {
          method: 'DELETE',
          headers: { 'X-Feedback-Admin-Auth': authToken }
        });

        if (!res.ok) {
          throw new Error('Delete failed');
        }

        loadFeedback(); // Reload data
      } catch (err) {
        alert('Failed to delete response');
      }
    }

    // Logout
    function logout() {
      authToken = null;
      sessionStorage.removeItem('feedbackAdminAuth');
      document.getElementById('loginBox').style.display = 'block';
      document.getElementById('adminView').classList.remove('active');
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      document.getElementById('loginError').textContent = '';
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
