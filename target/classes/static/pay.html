<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Payment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; background: #f8f8f8; padding: 2em; }
    .container { max-width: 420px; margin: auto; background: #fff; padding: 2em; border-radius: 8px; box-shadow: 0 2px 8px #ccc; }
    label { display: block; margin-top: 1em; }
    input[type="number"], input[type="email"] { width: 100%; padding: 0.5em; margin-top: 0.5em; }
    #card-container { margin-top: 0.75em; border: 1px solid #ccc; border-radius: 4px; padding: 0.75em; }
    #card-errors { color: #c00; margin-top: 0.5em; min-height: 1.25em; }
    button { margin-top: 1.5em; padding: 0.7em 2em; background: #c9b037; color: #fff; border: none; border-radius: 4px; font-size: 1em; cursor: pointer; }
    button[disabled] { background: #999; cursor: not-allowed; }
    .info { margin-top: 1em; color: #555; }
    .error { color: #c00; margin-top: 1em; }
    .status { margin-top: 1em; min-height: 1.5em; }
    .status.error { color: #c00; }
    .status.success { color: #0a7a3c; }
    .method-toggle { display: flex; gap: 1em; flex-wrap: wrap; margin-top: 1.25em; }
    .method-toggle label { display: flex; align-items: center; gap: 0.4em; font-weight: 600; cursor: pointer; }
    .section { margin-top: 1.25em; }
    #ach-section { display: none; }
    .field-row { display: flex; flex-wrap: wrap; gap: 1em; }
    .field-row label { flex: 1 1 150px; }
    .ach-note { background: #eef5ff; border: 1px solid #cbe0ff; border-radius: 4px; padding: 0.75em; color: #1f3b64; font-size: 0.95em; margin-top: 0.75em; }
  </style>
  <script src="https://web.squarecdn.com/v1/square.js"></script>
  <script>
    function getStudentId() {
      // Expect URL like /pay/123456
      const path = window.location.pathname;
      const match = path.match(/\/pay\/(\w+)/);
      return match ? match[1] : '';
    }

    function getDue() {
      // Support /pay/{studentId}/{due} or ?due=
      const path = window.location.pathname;
      const parts = path.split('/');
      let due = null;
      if (parts.length >= 4 && parts[3]) {
        const parsed = parseFloat(parts[3]);
        if (!Number.isNaN(parsed) && parsed > 0) due = parsed;
      }
      if (due == null) {
        const qp = new URLSearchParams(window.location.search).get('due');
        if (qp) {
          const parsedQ = parseFloat(qp);
          if (!Number.isNaN(parsedQ) && parsedQ > 0) due = parsedQ;
        }
      }
      return due;
    }

    function currentPaymentMethod() {
      const selected = document.querySelector('input[name="paymentMethod"]:checked');
      return selected ? selected.value : 'CARD';
    }

    function toggleMethodUI() {
      const method = currentPaymentMethod();
      document.getElementById('card-section').style.display = method === 'CARD' ? 'block' : 'none';
      document.getElementById('ach-section').style.display = method === 'ACH' ? 'block' : 'none';
      document.getElementById('submitBtn').textContent = method === 'CARD' ? 'Pay with Card' : 'Pay with Bank Account';
      updateFee();
    }

    function updateFee() {
      const amountInput = document.getElementById('amount');
      const amount = parseFloat(amountInput.value) || 0;
      const method = currentPaymentMethod();
      if (method === 'ACH') {
        document.getElementById('cardFeeInfo').style.display = 'none';
        document.getElementById('achInfo').style.display = 'block';
        document.getElementById('fee').textContent = '0.00';
        document.getElementById('total').textContent = amount.toFixed(2);
      } else {
        const rate = 0.029;
        const fixedFee = 0.30;
        const total = amount ? Math.round(((amount + fixedFee) / (1 - rate)) * 100) / 100 : 0;
        document.getElementById('fee').textContent = (total - amount).toFixed(2);
        document.getElementById('total').textContent = total.toFixed(2);
        document.getElementById('cardFeeInfo').style.display = 'block';
        document.getElementById('achInfo').style.display = 'none';
      }
    }

    function setStatus(message, type) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message || '';
      statusEl.className = 'status' + (type ? ' ' + type : '');
    }

    function achTransactionKey(studentId) {
      return 'sq-ach-txn-' + studentId;
    }

    function ensureAchTransactionId(studentId) {
      const key = achTransactionKey(studentId);
      let existing = null;
      try {
        existing = window.sessionStorage.getItem(key);
      } catch (err) {
        existing = null;
      }
      if (!existing) {
        const generated = (window.crypto && window.crypto.randomUUID)
          ? window.crypto.randomUUID()
          : 'ach-' + Math.random().toString(36).slice(2);
        try {
          window.sessionStorage.setItem(key, generated);
        } catch (err) {
          // Ignore storage errors (private browsing, etc.)
        }
        existing = generated;
      }
      return existing;
    }

    let sqPayments;
    let sqCard;
    let sqAch;

    function baseRedirectUri() {
      const url = new URL(window.location.href);
      return url.origin + url.pathname;
    }

    async function initializeSquare(studentId) {
      const submitBtn = document.getElementById('submitBtn');
      const achRadio = document.getElementById('methodAch');
      try {
        const res = await fetch('/api/payments/config');
        if (!res.ok) throw new Error('Failed to load Square configuration');
        const cfg = await res.json();
        sqPayments = window.Square.payments(cfg.applicationId, cfg.locationId);
        sqCard = await sqPayments.card();
        await sqCard.attach('#card-container');
        submitBtn.disabled = false;
      } catch (err) {
        console.error('Square init error', err);
        setStatus('Payment form could not load. Please refresh or contact support.', 'error');
        submitBtn.disabled = true;
        return;
      }

      try {
        const transactionId = ensureAchTransactionId(studentId);
        sqAch = await sqPayments.ach({
          redirectURI: baseRedirectUri(),
          transactionId: transactionId
        });
        achRadio.disabled = false;
      } catch (err) {
        console.info('ACH init unavailable', err);
        achRadio.disabled = true;
        document.getElementById('achNote').textContent = 'Bank payments are unavailable right now. Please use a card payment.';
        if (document.getElementById('methodCard')) {
          document.getElementById('methodCard').checked = true;
          toggleMethodUI();
        }
      }
    }

    async function tokenizeCard() {
      const result = await sqCard.tokenize();
      if (result.status === 'OK') {
        document.getElementById('card-errors').textContent = '';
        return { token: result.token, verificationToken: result.verificationToken || null };
      }
      const errors = (result.errors || []).map(e => e.message).join(', ');
      document.getElementById('card-errors').textContent = errors || 'Unable to tokenize card.';
      throw new Error(errors || 'Unable to tokenize card');
    }

    async function tokenizeAch(amount) {
      if (!sqAch) {
        throw new Error('Bank payments are unavailable on this device.');
      }
      const firstName = (document.getElementById('achFirstName').value || '').trim();
      const lastName = (document.getElementById('achLastName').value || '').trim();
      if (!firstName || !lastName) {
        throw new Error('Enter the account holder\'s first and last name for bank payments.');
      }
      const accountHolderName = `${firstName} ${lastName}`.trim();
      const result = await sqAch.tokenize({
        accountHolderName,
        intent: 'CHARGE',
        amount: amount.toFixed(2),
        currency: 'USD'
      });
      if (result.status === 'OK') {
        return { token: result.token, accountHolderName };
      }
      const errors = (result.errors || []).map(e => e.message).join(', ');
      throw new Error(errors || 'Unable to verify bank account.');
    }

    window.onload = function() {
      const studentId = getStudentId();
      const formEl = document.getElementById('pay-form');
      const submitBtn = document.getElementById('submitBtn');
      const achRadio = document.getElementById('methodAch');
      const methodRadios = document.querySelectorAll('input[name="paymentMethod"]');

      if (!studentId) {
        formEl.style.display = 'none';
        document.getElementById('error-message').style.display = 'block';
        return;
      }

      document.getElementById('studentId').value = studentId;
      document.getElementById('studentIdLegacy').value = studentId;

      const due = getDue();
      if (due != null) {
        document.getElementById('amountDue').textContent = due.toFixed(2);
        document.getElementById('amountDueRow').style.display = 'block';
      }

      document.getElementById('amount').addEventListener('input', updateFee);
      methodRadios.forEach(radio => {
        radio.addEventListener('change', toggleMethodUI);
      });

      toggleMethodUI();

      formEl.addEventListener('submit', async function (evt) {
        evt.preventDefault();
        const method = currentPaymentMethod();
        const amount = parseFloat(document.getElementById('amount').value);
        if (!amount || amount <= 0) {
          setStatus('Enter a valid amount greater than zero.', 'error');
          return;
        }

        if (method === 'CARD' && !sqCard) {
          setStatus('Payment form not ready yet. Please wait a moment.', 'error');
          return;
        }

        if (method === 'ACH' && (achRadio.disabled || !sqAch)) {
          setStatus('Bank payments are unavailable right now. Please choose card.', 'error');
          return;
        }

        setStatus('Processing payment...', null);
        submitBtn.disabled = true;

        try {
          let tokenInfo;
          let verificationToken = null;
          let accountHolderName = null;

          if (method === 'CARD') {
            tokenInfo = await tokenizeCard();
            verificationToken = tokenInfo.verificationToken;
          } else {
            tokenInfo = await tokenizeAch(amount);
            accountHolderName = tokenInfo.accountHolderName;
          }

          const payload = {
            amount: amount.toFixed(2),
            studentId: studentId,
            sourceId: tokenInfo.token,
            paymentMethod: method
          };

          if (verificationToken) {
            payload.verificationToken = verificationToken;
          }

          if (accountHolderName) {
            payload.accountHolderName = accountHolderName;
          }

          const emailField = document.getElementById('payerEmail');
          if (emailField && emailField.value.trim()) {
            payload.email = emailField.value.trim();
          }

          const resp = await fetch('/api/payments/charge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!resp.ok) {
            const errBody = await resp.json().catch(() => ({}));
            throw new Error(errBody.message || 'Charge failed');
          }

          const data = await resp.json();

          if (method === 'ACH') {
            setStatus('Bank payment authorized! Funds move in 1-2 business days. Watch for a receipt email when it completes.', 'success');
            if (data.receiptUrl) {
              document.getElementById('achInfo').innerHTML = 'You can check the pending receipt anytime: <a href="' + data.receiptUrl + '" target="_blank" rel="noreferrer">open receipt</a>.';
              document.getElementById('achInfo').style.display = 'block';
            }
          } else {
            setStatus('Payment successful! Redirecting to receipt...', 'success');
            if (data.receiptUrl) {
              window.setTimeout(() => window.location.href = data.receiptUrl, 1200);
            }
          }
        } catch (err) {
          console.error('Payment error', err);
          setStatus(err.message || 'Payment failed. Please verify details and try again.', 'error');
          submitBtn.disabled = false;
          return;
        }
      });

      updateFee();
      initializeSquare(studentId);
    };
  </script>
</head>
<body>
    <div class="container">
      <h1>Student Payment</h1>
      <div id="error-message" class="error" style="display:none;">
        <strong>Error:</strong> No student ID found in the link.<br>
        You must pay through the <b>Band Camp Registration App</b> to ensure your payment is correctly applied.<br>
        <a href="/">Return to Home</a>
      </div>
      <div id="amountDueRow" class="info" style="display:none;">
        Amount Due: $<span id="amountDue">0.00</span>
      </div>
      <form id="pay-form" method="POST" action="/pay">
        <!-- Hidden student id fields for compatibility -->
        <input type="hidden" id="studentId" name="studentIdParam" />
        <input type="hidden" id="studentIdLegacy" name="studentId" />
        <label>Amount to Pay ($):
          <input type="number" id="amount" name="amount" min="1" max="10000" step="0.01" required />
        </label>
        <label>Email (optional, for receipt):
          <input type="email" id="payerEmail" name="email" placeholder="you@example.com" />
        </label>
        <div class="method-toggle" id="methodToggle">
          <label><input type="radio" name="paymentMethod" value="CARD" id="methodCard" checked> Card</label>
          <label><input type="radio" name="paymentMethod" value="ACH" id="methodAch" disabled> Bank Account (ACH)</label>
        </div>
        <div class="section" id="card-section">
          <label>Card Details:</label>
          <div id="card-container"></div>
          <div id="card-errors"></div>
        </div>
        <div class="section" id="ach-section">
          <div class="field-row">
            <label>Account Holder First Name:
              <input type="text" id="achFirstName" autocomplete="given-name" />
            </label>
            <label>Account Holder Last Name:
              <input type="text" id="achLastName" autocomplete="family-name" />
            </label>
          </div>
          <div class="ach-note" id="achNote">
            Bank payments are verified through Plaid. You must use a US checking account.
          </div>
        </div>
        <div class="info" id="cardFeeInfo">
          Estimated Square Fee: $<span id="fee">0.00</span><br>
          Total Charged: $<span id="total">0.00</span>
        </div>
        <div class="info" id="achInfo" style="display:none;">
          Bank transfers settle in 1-2 business days with no card surcharge.
        </div>
        <button type="submit" id="submitBtn" disabled>Pay with Card</button>
        <div id="status" class="status"></div>
      </form>
    </div>
</body>
</html>
